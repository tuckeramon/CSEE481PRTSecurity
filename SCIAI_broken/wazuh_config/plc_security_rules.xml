<!--
  Wazuh Custom Rules for PLC Security Monitoring

  These rules demonstrate how a SIEM processes raw security logs and generates
  alerts based on severity and event patterns.

  RULE STRUCTURE:
  - Each rule has a unique ID (100000+ range for custom rules)
  - Rules match based on decoded fields from the JSON logs
  - Severity levels: 0-3 (low), 4-7 (medium), 8-11 (high), 12-15 (critical)
  - Rules can generate alerts, trigger active responses, or both

  INSTALLATION:
  Copy this file to: /var/ossec/etc/rules/plc_security_rules.xml
  Then restart Wazuh: systemctl restart wazuh-manager

  For Windows agent with local rules:
  Copy to: C:\Program Files (x86)\ossec-agent\ruleset\rules\

  RULE GROUPS:
  - plc_security: All PLC security events
  - ics_security: Industrial Control System events
  - mode_change: Controller mode transitions
  - fault: Hardware/software faults
  - baseline: Configuration deviations
-->

<group name="plc_security,ics_security,">

  <!-- ================================================================
       BASE RULE: Match all PLC security events
       This parent rule matches any event from our PLC security logger
       ================================================================ -->
  <rule id="100000" level="3">
    <decoded_as>json</decoded_as>
    <field name="source">plc_security</field>
    <description>PLC Security: General event from industrial controller</description>
    <group>plc_security,</group>
  </rule>

  <!-- ================================================================
       CONNECTION EVENTS
       Track when the security monitor connects/disconnects from PLCs
       ================================================================ -->
  <rule id="100010" level="3">
    <if_sid>100000</if_sid>
    <field name="event_type">CONNECTION</field>
    <field name="severity">INFO</field>
    <description>PLC Security: Monitor connected to controller at $(plc_ip)</description>
    <group>plc_security,connection,</group>
  </rule>

  <rule id="100011" level="10">
    <if_sid>100000</if_sid>
    <field name="event_type">CONNECTION</field>
    <field name="severity">ERROR</field>
    <description>PLC Security: FAILED to connect to controller at $(plc_ip)</description>
    <group>plc_security,connection,connection_failure,</group>
  </rule>

  <!-- ================================================================
       MODE CHANGE EVENTS
       - When the mode of PLC operation is changed
       - Run mode: Normal operation
       - Program mode: Allows code changes (DANGEROUS if unauthorized)
       - Remote mode: Can be changed remotely
       ================================================================ -->
  <rule id="100020" level="8">
    <if_sid>100000</if_sid>
    <field name="event_type">MODE_CHANGE</field>
    <field name="severity">WARNING</field>
    <description>PLC Security: Controller mode changed from $(previous_state) to $(current_state)</description>
    <group>plc_security,mode_change,</group>
  </rule>

  <rule id="100021" level="12">
    <if_sid>100000</if_sid>
    <field name="event_type">MODE_CHANGE</field>
    <field name="severity">ERROR</field>
    <description>PLC Security: CRITICAL - Controller entered PROGRAM mode (code changes allowed)</description>
    <group>plc_security,mode_change,program_mode,</group>
  </rule>

  <!-- Frequency rule: Multiple mode changes in short time = suspicious -->
  <rule id="100022" level="14" frequency="3" timeframe="300">
    <if_matched_sid>100020</if_matched_sid>
    <same_field>plc_ip</same_field>
    <description>PLC Security: ALERT - Multiple mode changes detected on $(plc_ip) - possible attack</description>
    <group>plc_security,mode_change,attack,</group>
  </rule>

  <!-- ================================================================
       FAULT EVENTS
       Hardware or software faults on the PLC
       ================================================================ -->
  <rule id="100030" level="7">
    <if_sid>100000</if_sid>
    <field name="event_type">FAULT</field>
    <field name="severity">WARNING</field>
    <description>PLC Security: Minor fault detected on $(plc_ip)</description>
    <group>plc_security,fault,minor_fault,</group>
  </rule>

  <rule id="100031" level="14">
    <if_sid>100000</if_sid>
    <field name="event_type">FAULT</field>
    <field name="severity">CRITICAL</field>
    <description>PLC Security: MAJOR FAULT on $(plc_ip) - immediate attention required</description>
    <group>plc_security,fault,major_fault,</group>
  </rule>

  <!-- ================================================================
       BASELINE DEVIATION EVENTS
       Detects changes to PLC configuration that deviate from expected state

       These include events like:
       - Serial number change = device was replaced (VERY suspicious)
       - Firmware change = unauthorized update
       - Product type change = different device connected
       ================================================================ -->
  <rule id="100040" level="10">
    <if_sid>100000</if_sid>
    <field name="event_type">BASELINE_DEVIATION</field>
    <field name="severity">WARNING</field>
    <description>PLC Security: Baseline deviation - $(message)</description>
    <group>plc_security,baseline,deviation,</group>
  </rule>

  <rule id="100041" level="15">
    <if_sid>100000</if_sid>
    <field name="event_type">BASELINE_DEVIATION</field>
    <field name="severity">CRITICAL</field>
    <description>PLC Security: CRITICAL BASELINE VIOLATION on $(plc_ip) - $(message)</description>
    <group>plc_security,baseline,critical_deviation,</group>
  </rule>

  <!-- Serial number change is always critical -->
  <rule id="100042" level="15">
    <if_sid>100040,100041</if_sid>
    <match>SERIAL NUMBER CHANGED</match>
    <description>PLC Security: DEVICE REPLACED - Serial number mismatch on $(plc_ip)</description>
    <group>plc_security,baseline,device_replacement,</group>
  </rule>

  <!-- ================================================================
       STATUS EVENTS
       Periodic health checks for audit trail
       ================================================================ -->
  <rule id="100050" level="1">
    <if_sid>100000</if_sid>
    <field name="event_type">STATUS</field>
    <description>PLC Security: Periodic status check for $(plc_ip)</description>
    <group>plc_security,status,audit,</group>
  </rule>

  <!-- ================================================================
       CONFIG CHANGE EVENTS
       Configuration modifications on the PLC
       ================================================================ -->
  <rule id="100060" level="8">
    <if_sid>100000</if_sid>
    <field name="event_type">CONFIG_CHANGE</field>
    <description>PLC Security: Configuration change detected on $(plc_ip)</description>
    <group>plc_security,config_change,</group>
  </rule>

  <!-- ================================================================
       CORRELATION RULES
       Detect attack patterns by correlating multiple events
       ================================================================ -->

  <!-- Connection failure followed by successful connection = possible bruteforce -->
  <rule id="100100" level="12" frequency="5" timeframe="60">
    <if_matched_sid>100011</if_matched_sid>
    <same_field>plc_ip</same_field>
    <description>PLC Security: Multiple connection failures to $(plc_ip) - possible attack</description>
    <group>plc_security,attack,bruteforce,</group>
  </rule>

  <!-- Fault immediately after mode change = suspicious -->
  <rule id="100101" level="13">
    <if_sid>100031</if_sid>
    <if_matched_sid>100020</if_matched_sid>
    <same_field>plc_ip</same_field>
    <options>same_source_ip</options>
    <description>PLC Security: Fault after mode change on $(plc_ip) - possible malicious code execution</description>
    <group>plc_security,attack,malware,</group>
  </rule>

</group>
